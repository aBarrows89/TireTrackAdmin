name: Simple Tire FTP Export

on:
  schedule:
    # 11pm EST = 4am UTC (EST is UTC-5)
    # During DST (EDT), 11pm EDT = 3am UTC
    - cron: '0 4 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  export-to-ftp:
    runs-on: ubuntu-latest

    steps:
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get today's date (EST)
        id: date
        run: |
          # Get current date in EST timezone
          DATE=$(TZ='America/New_York' date +%Y-%m-%d)
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "Today's date (EST): $DATE"

      - name: Fetch Simple Tire scans from Convex
        id: fetch
        env:
          CONVEX_URL: ${{ secrets.CONVEX_URL }}
        run: |
          # Use Node.js to calculate timestamps and fetch data (more reliable than bash date)
          node -e "
            const fs = require('fs');
            const https = require('https');

            // Get today's date in EST
            const now = new Date();
            const estOptions = { timeZone: 'America/New_York' };
            const estDateStr = now.toLocaleDateString('en-CA', estOptions); // YYYY-MM-DD format

            // Calculate start/end of day in EST
            const startOfDay = new Date(estDateStr + 'T00:00:00-05:00');
            const endOfDay = new Date(estDateStr + 'T23:59:59.999-05:00');

            const startTs = startOfDay.getTime();
            const endTs = endOfDay.getTime();

            console.log('Date (EST):', estDateStr);
            console.log('Fetching scans from', startTs, 'to', endTs);

            const convexUrl = process.env.CONVEX_URL;
            if (!convexUrl) {
              console.error('CONVEX_URL not set');
              process.exit(1);
            }

            const postData = JSON.stringify({
              path: 'queries:getVendorDateRangeReport',
              args: {
                startDate: startTs,
                endDate: endTs,
                vendor: 'Simple Tire'
              }
            });

            const url = new URL(convexUrl + '/api/query');
            const options = {
              hostname: url.hostname,
              port: 443,
              path: url.pathname,
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Content-Length': Buffer.byteLength(postData)
              }
            };

            const req = https.request(options, (res) => {
              let data = '';
              res.on('data', chunk => data += chunk);
              res.on('end', () => {
                try {
                  const response = JSON.parse(data);
                  const scans = response.value?.byVendor?.['Simple Tire'] || [];

                  console.log('Scan count:', scans.length);

                  if (scans.length === 0) {
                    fs.writeFileSync('scan_count.txt', '0');
                    return;
                  }

                  // Generate CSV
                  const csvRows = [
                    'Tracking Number,Carrier,Truck Number,Recipient Name,Address,City,State,Destination,Scanned At,Vendor Account'
                  ];

                  for (const scan of scans) {
                    const scannedAt = new Date(scan.scannedAt).toISOString();
                    csvRows.push([
                      '\"' + (scan.trackingNumber || '') + '\"',
                      '\"' + (scan.carrier || '') + '\"',
                      '\"' + (scan.truckNumber || '') + '\"',
                      '\"' + (scan.recipientName || '') + '\"',
                      '\"' + (scan.address || '') + '\"',
                      '\"' + (scan.city || '') + '\"',
                      '\"' + (scan.state || '') + '\"',
                      '\"' + (scan.destination || '') + '\"',
                      '\"' + scannedAt + '\"',
                      '\"' + (scan.vendorAccount || '') + '\"'
                    ].join(','));
                  }

                  fs.writeFileSync('simpletire_manifest.csv', csvRows.join('\n'));
                  fs.writeFileSync('scan_count.txt', scans.length.toString());
                  console.log('CSV file created with ' + scans.length + ' rows');
                } catch (e) {
                  console.error('Parse error:', e.message);
                  console.error('Response:', data);
                  process.exit(1);
                }
              });
            });

            req.on('error', (e) => {
              console.error('Request error:', e.message);
              process.exit(1);
            });

            req.write(postData);
            req.end();
          "

          SCAN_COUNT=$(cat scan_count.txt 2>/dev/null || echo "0")
          echo "scan_count=$SCAN_COUNT" >> $GITHUB_OUTPUT

      - name: Upload to Simple Tire FTP
        if: steps.fetch.outputs.scan_count != '0'
        run: |
          FILENAME="simpletire_manifest_${{ steps.date.outputs.date }}.csv"

          echo "Uploading $FILENAME with ${{ steps.fetch.outputs.scan_count }} scans..."

          # Upload using curl with FTP
          curl --insecure -v \
            -T simpletire_manifest.csv \
            -u "${{ secrets.SIMPLETIRE_FTP_USER }}:${{ secrets.SIMPLETIRE_FTP_PASSWORD }}" \
            "ftp://${{ secrets.SIMPLETIRE_FTP_HOST }}/Labels/$FILENAME"

          echo "Upload complete!"

      - name: Skip notification (no scans)
        if: steps.fetch.outputs.scan_count == '0'
        run: |
          echo "No Simple Tire scans found for today (${{ steps.date.outputs.date }}). Skipping upload."
